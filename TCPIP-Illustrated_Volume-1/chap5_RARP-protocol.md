# RARP:逆地址解析协议
如果局域网中的主机只知道自己的MAC地址，不知道IP地址，可以通过ARAP协议发出广播请求，由RARP服务器回答。
它是许多[无盘系统](https://baike.baidu.com/item/%E6%97%A0%E7%9B%98%E7%B3%BB%E7%BB%9F/10644051?fr=aladdin)在引导时用来获取IP地址。
## RARP数据帧格式
与[ARP数据帧格式](chap4_ARP-protocol.md/#ARP数据帧格式)基本相同，主要区别在于：
- RARP请求或应答帧类型为0X8035;
- RARP请求的操作码为3，应答操作码为4；

ARP和RARP以**广播方式请求**，以**单播方式应答**。

## RARP协议工作流程：
- 主机广播RARP请求，声明自己的MAC地址；
- 本网段的所有主机都会接受请求数据包，检查自身的RARP列表，若未找到，则丢弃该请求包；若找到，则发送响应数据包，提供IP地址；
- 源主机受到RARP响应信号，就可利用得到的IP地址通信；若一直未收到，表示初始化失败。

## 疑难点
### 1. NAT技术
<span id="NAT技术"></span>IPv4最多只能支持40+亿个IP地址，不够使用。因此，引入**NAT**（Network Address Translation）技术,将内网设备的IP地址与对应的唯一的外网地址相互转化。内网设备使用同一外网地址，为了区分具体哪个设备在请求网络服务，可以通过内网**IP地址**和**端口（port）号**确定。转换示意图如下：  
<div align=left><img width="500" height="250" src="./images/NAT.png"/></div>  
 
NAT表保存了旧的地址、端口号与新的地址端口号映射关系：
|方向|旧的地址和端口|新的地址与端口|
|-|-|-|
|出|172.168.2.11:6666|173.21.59.10:16666|
|出|172.168.2.10:7777|173.21.59.10:17777|
|入|173.21.59.10:16666|172.168.2.11:6666|
|出|173.21.59.10:17777|172.168.2.10:7777|  

具体转换过程如下：
- 电脑的某个进程与外网通信，内网的IP地址与端口号会重新转换为新的外网唯一IP地址与端口号，手机端类似； 
-  外网返回数据信息时，外网的IP地址和端口号会重新转换为内网的IP地址和端口号。



