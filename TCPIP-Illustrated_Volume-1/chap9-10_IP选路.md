## 静态IP选路
选路是IP最重要的功能之一，它决定了数据报在网络中传输的路径。其主要实现基于路由表，通过指令`netstat -r`可以显示路由表，如下图所示：
<div align=left><img width="450" height="120" src="./images/路由表.JPG"/></div>

第1行说明，如果目的地是 140.252.13.65（slip主机），那么网关（路由器）将把分组转
发给140.252.13.35（bsdi）。对于给定的路由器，有以下五种标志（flag）：  
- U  该路由可用
- G  该路由是到一个网关（路由器）。如果没有，表示目的地址直连
- H  该路由是到一个主机，目的地址是一个完整的主机地址。如果没有，表示路由到一个网络，目的地址是一个网络地址（主机号部分为 0）
- D  表明该路由是为重定向报文创建的
- M   表明该路由已经被重定向报文修改

因此，IP选路的步骤如下：  
1. 搜索匹配的主机地址，也就是用IP地址匹配那些带H标志的目标主机地址；
2. 若1失败（未查询到目标主机IP地址），就搜索匹配的网络地址；
3. 若2失败，搜索默认表项，也就是发送到默认网关。

如果路由表中未匹配到任何表项，如果数据报由主机产生，就会返回一个“主机不可达差错”或“网络不可达差错”；如果是被转发的数据报，就会给原始发送端返回一个ICMP主机不可达的差错报文。

## ICMP重定向差错
当IP数据报应该被发送到另一个路由器	R2时，收到数据报的路由器R1就要发送 ICMP重定向差
错报文给IP数据报的发送端。
<div align=left><img width="450" height="220" src="./images/ICMP重定向.JPG"/></div>  

工作过程如下：
1. 若R1是主机的默认路由，则主机可能将数据报发送至R1；
2. R12接收到数据报并查询路由表，发现R2是下一跳。当把数据报转发至R2时，R1发现即将要发送的接口与数据报到达的接口相同（也就是主机和两个路由器在一个局域网）。此时，会导致重定向；
3. R1发送一个ICMP重定向报文给主机，告知以后把数据报直接发给R2，主机也会在路由表中做相应的改动。

## ICMP路由器发现报文
主机在引导以后要**广播或多播**传送一份路由器请求报文。一台或更多台路由器响应一份路由器通告报文。另外，路由器定期地广播或多播传送它们的路由器通告报文，允许每个正在监听的主机相应地更新它们的路由表
其中，请求报文格式（如广播）如下：
<div align=left><img width="400" height="120" src="./images/ICMP请求报文.JPG"/></div> 

路由器在一份报文中可以通告多个地址。其中，IP地址必须是发送路由器的某个地址。优先级是一个有符号的 32 bit整数，指出该 IP地址作为默认路由器地址的优先等级，如下图所示：

<div align=left><img width="450" height="220" src="./images/ICMP通告报文.JPG"/></div> 

-----------------------------------------------
## 动态IP选路
静态选路就是在配置接口的时候，以默认的方式生成路由表项。并通过route来增加表项，或者通过ICMP报文来更新表项（通常在默认方式出错的情况下）。 若上诉三种方法都不能满足，那么需要使用动态选路。

动态选路协议使用相邻路由器之间互相通信。系统（路由选择程序）选择比较合适的路由放到核心路由表中，然后系统就可以根据这个核心路有表找到最合适的网路。也就是说，动态选路是在系统核心网络外部进行的，它只是用一些选路的策略影响路由表，而不会影响到最后通过路由表选择路由的那一部分。
