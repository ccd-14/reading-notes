# ARP:地址解析协议  
在链路层，同一局域网的两台主机之间的通信，需要通过MAC地址定位后才能传输数据包；  
在传输层和网络层，计算机之间通过IP地址定位目标主机，数据报只包含了IP地址，不存在MAC地址；  
因此，在发送数据包之前，需要将目标IP地址转换为MAC地址，才能传输至目标主机。  
`ARP协议`通过 IP 地址向 MAC 地址的转换，解决网络层和链路层的衔接问题。

## ARP数据帧格式
在以太网上解析IP地址时，ARP请求和响应数据帧的格式如下：  
<div align=left><img width="700" height="150" src="./images/以太网ARP数据帧格式.png"/></div>   
其中，每个字段的含义如下： 
 
|字段|含义|
|-|-|
|以太网目的地址|目的地址全为1，即0XFFFFFFFFFFFF,表示**广播地址**，所有以太网接口都要接受该数据帧|
|以太网源地址|源主机MAC地址|
|帧类型|表示后面数据类型，0X0806表示ARP请求/响应|
|硬件类型|表示硬件地址的类型，值1表示以太网地址|
|协议地址|表示要映射的协议地址类型，值0X0800表示IP地址|
|硬件地址长度|值为6，转换后MAC地址的长度|
|协议地址长度|值为4，要转换的IP地址的长度|
|操作|ARP请求（值为1）、ARP响应（值为2）、RARP请求（值为3），RARP响应（值为4）|
|发送端以太网地址|发送端MAC地址，请求/响应端主机地址|
|发送端IP地址|发送端IP地址，请求/响应端主机地址|
|目的以太网地址|响应端填充，响应包含有|
|目的IP地址|请求端填写|  

**说明**：当系统收到一份目的端为本机的ARP请求报文后，它就把硬件地址填进去，然后用两个目的端地址分别替换两个发送端地址，并把操作字段置为2，最后把响应包发送回去

## ARP缓存
ARP缓存表存储了**IP地址**到**硬件地址**（MAC）之间的映射关系。为了避免重复发送 ARP 请求，每台主机都有一个 ARP 高速缓存。当主机得到 ARP 响应后，将目标主机的 IP 地址和物理地址存入本机 ARP 缓存中，并保留一定时间。

## ARP工作流程
ARP 工作流程分为两个阶段，一个是 ARP 请求过程，另一个是ARP响应过程。 
- 当主机A和主机B要通信时，如果下一跳的IP地址处于ARP缓存表中，则直接或得目标MAC地址，数据帧传输至目标主机；
- 如果下一跳的IP地址不在ARP缓存表中，则需要发出<span id="ARP请求"></span>`ARP请求`:  
  - 主机A广播ARP请求帧（目的NAC地址位全为1），所有本地网络上的主机都会接受到该请求包；
- 如果主机发现请求的 IP 地址与自己的 IP 地址不匹配，它将丢弃 ARP 请求。主机 B 确定 ARP 请求中的 IP 地址与自己的 **IP 地址匹配**，则将主机 A 的 IP 地址和 MAC 地址映射添加到本地 ARP 缓存中。并做出<span id="ARP响应"></span>`ARP响应`：  
- -  主机B将包含自身 MAC 地址的 ARP 回复消息直接发送给主机A；
- 当主机 A 收到从主机 B 发来的 ARP 回复消息时，会用主机 B 的 IP 地址和 MAC 地址更新 ARP 缓存；
- 主机A发送**IP数据报**到目的主机B 
 



