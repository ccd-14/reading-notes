## ICMP协议应用-traceroute
Traceroute程序可以获知IP数据报从一台主机到另一台主机所经过的路由路径，并且可以记录的路由IP地址可达255个。

Traceroute程序使用**ICMP报文**和IP首部中的**TTL字段**（生存周期）。TTL字段是由发送端初始设置一个8 bit字段。每个处理数据报的路由器都会将TTL减 1，如果接收的TTL为1，那么非目标主机（路由器）就会不转发该数据报，并给源主机发一份** ICMP“超时”信息**。该超时报文中源IP地址是发送该报文的主机/路由器。

:question:  判别是否到达目标主机：
Traceroute发送一份**UDP数据报**给目的主机，但它选择一个不可能的值作为 **UDP端口号**（大于 30 000），使目的主机的任何一个应用程序都不可能使用该端口。因为，当该数据报到达时，将使目的主机的 UDP模块产生一份**“端口不可达”**错误的ICMP报文。这样，Traceroute程序所要做的就是区分接收到的ICMP报文是超时还是端口不可达，以判断什么时候结束。

## traceroute流程

:one: 源主机向目的主机发送一连串的 IP 数据报（UDP报文）。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个包含自身 IP 地址(R1)的 ICMP 时间超过差错报告报文；
:two: 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个包含自身 IP 地址(R2) ICMP 时间超过差错报文。  
:three: 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送包含自身 IP 地址 ICMP 端口不可达差错报告报文。  
:four: 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

:warning:  注意：  
- 并不能保证现在的路由也是将来所要采用的路由，甚至两份连续的 IP 数据报都可能采用不同的路由；
- 不能保证ICMP报文的路由与traceroute程序发送的UDP数据报采用同一路由；
- 返回的 ICMP报文中的信源 IP地址是UDP数据报到达的路由器接口的 IP地址。

## IP源站选路选项
通常IP路由是动态的，即每个路由器都要判断数据报下面该转发到哪个路由器。应用程序对此不进行控制，而且通常也并不关心路由。  
源站选路由发送者指定路由，可分为以下两种形式：  
- 严格的源路由选择：发送端指明 IP数据报所必须采用的确切路由，并且每个相邻的IP地址对应路由器必须**直连**。也就是每一跳要严格按照路由要求，并且指向是直连的路由设备；
- 宽松的源站选路：发送端指明了一个数据报经过的 IP地址清单，但是数据报在清单上指明的任意两个地址之间可以通过其他路由器。
 